# Обработка ошибок API

## Формат ответа об ошибке

Все ошибки возвращаются в едином формате:

```json
{
  "statusCode": 400,
  "message": "Текст, понятный пользователю, с подсказкой как исправить",
  "error": "Краткое название типа ошибки",
  "details": {},
  "path": "/api/...",
  "timestamp": "2025-02-19T12:00:00.000Z"
}
```

- **statusCode** — HTTP-код (400, 401, 403, 404, 409, 503, 500).
- **message** — основное сообщение на русском; для валидации — сводка или одно сообщение.
- **error** — короткое имя типа: «Ошибка запроса», «Требуется авторизация», «Не найдено», «Конфликт данных», «Ошибка валидации», «Сервис недоступен», «Ошибка сервера».
- **details** — опционально: массив ошибок по полям (при 400 от ValidationPipe) или отладочная информация в development.
- **path**, **timestamp** — для отладки.

## Коды и когда используются

| Код | error | Когда |
|-----|--------|-------|
| 400 | Ошибка запроса | Невалидные данные (в т.ч. ValidationPipe), нет полей для обновления и т.п. |
| 401 | Требуется авторизация | Нет/неверный JWT, неверный логин или пароль, истёкший refresh. |
| 403 | Доступ запрещён | Нет прав на действие (если используется). |
| 404 | Не найдено | Ресурс (категория, цель, подписка, пользователь и т.д.) не найден. |
| 409 | Конфликт данных | Дубликат (например, категория с таким id/именем), нельзя удалить из-за связей. |
| 503 | Сервис недоступен | ML-сервис или Telegram-бот недоступен. |
| 500 | Ошибка сервера | Необработанная ошибка; в production без деталей. |

## Валидация (400)

При ошибках ValidationPipe в **details** приходит массив объектов с полями **message** и при возможности **hint** (подсказка, как исправить):

```json
{
  "statusCode": 400,
  "message": "Ошибки валидации (2): email must be an email; password must be longer...",
  "error": "Ошибка запроса",
  "details": [
    { "message": "email must be an email", "hint": "Укажите корректный email, например: user@example.com" },
    { "message": "password must be longer than...", "hint": "Пароль обычно от 6 символов, с буквами и цифрами" }
  ],
  "path": "/api/auth/register",
  "timestamp": "..."
}
```

## Реализация

- **Глобальный фильтр:** `src/common/filters/http-exception.filter.ts` (`AllExceptionsFilter`).
- Подключён в `main.ts`: `app.useGlobalFilters(new AllExceptionsFilter())`.
- В сервисах используются стандартные исключения NestJS: `BadRequestException`, `UnauthorizedException`, `NotFoundException`, `ConflictException`, `ServiceUnavailableException`, `HttpException` — фильтр по ним выставляет **statusCode** и формирует **message**/ **error**/ **details**.

Рекомендация: в сервисах не использовать `throw new Error(...)` — бросать подходящее HTTP-исключение с понятным русским сообщением и при необходимости подсказкой в тексте.
